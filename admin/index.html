<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MAKAUT Scholar · Admin Portal</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap');

        :root {
            --bg: #0B0D11;
            --sidebar: #0F1115;
            --surface: rgba(23, 26, 33, 0.4);
            --surface-solid: #171A21;
            --accent: #8E82FF;
            --accent-glow: rgba(142, 130, 255, 0.15);
            --border: rgba(255, 255, 255, 0.08);
            --text: #F5F6FA;
            --text-dim: #9AA0A6;
            --text-muted: #6C727F;
            --red: #FF6B6B;
            --green: #6BCB77;
            --orange: #FFB347;
            --sidebar-width: 280px;
            --radius: 20px;
            --radius-sm: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            overflow-x: hidden;
        }

        /* ── Animated Background ── */
        .ambient-bg {
            position: fixed;
            inset: 0;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }

        .glow {
            position: absolute;
            width: 800px;
            height: 800px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
            filter: blur(80px);
            opacity: 0.4;
            animation: drift 20s infinite alternate ease-in-out;
        }

        .glow-1 {
            top: -200px;
            right: -200px;
            background: radial-gradient(circle, rgba(142, 130, 255, 0.1) 0%, transparent 70%);
        }

        .glow-2 {
            bottom: -300px;
            left: -200px;
            animation-delay: -5s;
        }

        @keyframes drift {
            from {
                transform: translate(0, 0) scale(1);
            }

            to {
                transform: translate(100px, 50px) scale(1.1);
            }
        }

        /* ── Sidebar ── */
        aside {
            width: var(--sidebar-width);
            background: var(--sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 32px 16px;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 16px;
            margin-bottom: 48px;
        }

        .logo-box {
            width: 40px;
            height: 40px;
            background: var(--accent);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: white;
            box-shadow: 0 8px 16px rgba(142, 130, 255, 0.3);
        }

        .logo-text {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 700;
            font-size: 18px;
            letter-spacing: -0.5px;
        }

        nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: var(--radius-sm);
            color: var(--text-dim);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
            border: 1px solid transparent;
            cursor: pointer;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.03);
            color: var(--text);
        }

        .nav-item.active {
            background: var(--accent-glow);
            color: var(--accent);
            border-color: rgba(142, 130, 255, 0.1);
        }

        .nav-item i {
            width: 20px;
            font-size: 18px;
            text-align: center;
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 24px 16px;
            border-top: 1px solid var(--border);
        }

        #connectStatus {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-dot.ok {
            background: var(--green);
            box-shadow: 0 0 10px var(--green);
        }

        .status-dot.err {
            background: var(--red);
            box-shadow: 0 0 10px var(--red);
        }

        /* ── Main Content ── */
        main {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 48px;
            max-width: 1400px;
        }

        .page-header {
            margin-bottom: 40px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .page-title h1 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -1px;
            margin-bottom: 4px;
        }

        .page-title p {
            color: var(--text-muted);
            font-size: 15px;
        }

        /* ── Glass Components ── */
        .glass {
            background: var(--surface);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 32px;
            margin-bottom: 32px;
            transition: var(--transition);
        }

        .glass:hover {
            border-color: rgba(255, 255, 255, 0.12);
            background: rgba(23, 26, 33, 0.5);
        }

        .glass h2 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* ── Forms ── */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .field label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .field input,
        .field select,
        .field textarea {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 14px 16px;
            color: var(--text);
            font-family: inherit;
            font-size: 14px;
            outline: none;
            transition: var(--transition);
        }

        .field input:focus,
        .field select:focus {
            border-color: var(--accent);
            background: rgba(142, 130, 255, 0.05);
            box-shadow: 0 0 0 3px rgba(142, 130, 255, 0.1);
        }

        /* ── Buttons ── */
        .btn {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            padding: 14px 24px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(142, 130, 255, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* ── List Interface ── */
        .table-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .search-box {
            position: relative;
            width: 300px;
        }

        .search-box i {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .search-box input {
            padding-left: 40px !important;
            width: 100%;
        }

        .item-row {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            align-items: center;
            gap: 20px;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
            transition: var(--transition);
        }

        .item-row:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateX(4px);
        }

        .item-main {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }

        .item-name {
            font-weight: 600;
            font-size: 15px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .item-sub {
            font-size: 12px;
            color: var(--text-muted);
        }

        .badge {
            font-size: 11px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-dim);
        }

        .badge-premium {
            background: rgba(255, 179, 71, 0.1);
            color: var(--orange);
            border: 1px solid rgba(255, 179, 71, 0.2);
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }

        .icon-btn.delete:hover {
            color: var(--red);
            background: rgba(255, 107, 107, 0.1);
            border-color: rgba(255, 107, 107, 0.2);
        }

        /* ── Tabs Content ── */
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ── Connect Overlay ── */
        #loginOverlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-card {
            width: 100%;
            max-width: 440px;
            text-align: center;
        }

        /* ── File Drop ── */
        .dropzone {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.01);
        }

        .dropzone:hover {
            border-color: var(--accent);
            background: var(--accent-glow);
        }

        /* ── Toast ── */
        .toast {
            position: fixed;
            bottom: 32px;
            right: 32px;
            background: var(--surface-solid);
            border: 1px solid var(--border);
            padding: 16px 24px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5);
            transform: translateY(100px);
            opacity: 0;
            transition: var(--transition);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid var(--green);
        }

        .toast.error {
            border-left: 4px solid var(--red);
        }

        /* ── Modal ── */
        .modal-wrap {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-wrap.show {
            display: flex;
        }

        @media (max-width: 1024px) {
            :root {
                --sidebar-width: 80px;
            }

            .logo-text,
            .nav-item span,
            .sidebar-footer {
                display: none;
            }

            .logo {
                justify-content: center;
                padding: 0;
            }

            main {
                padding: 24px;
            }
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 20px;
            }

            .search-box {
                width: 100%;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>

<body>
    <div class="ambient-bg">
        <div class="glow glow-1"></div>
        <div class="glow glow-2"></div>
    </div>

    <!-- ── AUTH OVERLAY ── -->
    <div id="loginOverlay">
        <div class="login-card">
            <div class="logo" style="justify-content: center; margin-bottom: 32px;">
                <div class="logo-box">MS</div>
                <div class="logo-text">MAKAUT Scholar</div>
            </div>
            <div class="glass" style="text-align: left;">
                <h2 style="margin-bottom: 8px;">Admin Console</h2>
                <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 32px;">Connect to your Supabase
                    project to manage content.</p>

                <div class="field" style="margin-bottom: 20px;">
                    <label>Supabase URL</label>
                    <input type="text" id="supaUrl" placeholder="https://your-project.supabase.co" />
                </div>
                <div class="field" style="margin-bottom: 32px;">
                    <label>Service Role / Anon Key</label>
                    <input type="password" id="supaKey" placeholder="your-anon-key" />
                </div>
                <button class="btn" style="width: 100%;" onclick="connect()">
                    <span>Connect Database</span>
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
                <div id="loginStatus" style="margin-top: 16px; font-size: 12px; text-align: center; color: var(--red);">
                </div>
            </div>
        </div>
    </div>

    <!-- ── SIDEBAR ── -->
    <aside id="sidebar" style="display: none;">
        <div class="logo">
            <div class="logo-box">MS</div>
            <div class="logo-text">Admin</div>
        </div>

        <nav>
            <div class="nav-item active" onclick="switchTab('notes', this)">
                <i class="fa-solid fa-file-lines"></i>
                <span>Academic Notes</span>
            </div>
            <div class="nav-item" onclick="switchTab('syllabus', this)">
                <i class="fa-solid fa-graduation-cap"></i>
                <span>Syllabus</span>
            </div>
            <div class="nav-item" onclick="switchTab('pyq', this)">
                <i class="fa-solid fa-landmark"></i>
                <span>PYQ Papers</span>
            </div>
            <div class="nav-item" onclick="switchTab('imp', this)">
                <i class="fa-solid fa-bullseye"></i>
                <span>Exam Focus</span>
            </div>
            <div class="nav-item" onclick="switchTab('monetization', this)">
                <i class="fa-solid fa-coins"></i>
                <span>Monetization & Pricing</span>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div id="connectStatus">
                <div class="status-dot ok"></div>
                <span style="color: var(--text-dim);">Database Connected</span>
            </div>
        </div>
    </aside>

    <!-- ── MAIN ── -->
    <main id="mainContent" style="display: none;">

        <!-- NOTES TAB -->
        <section id="notesTab" class="tab-content active">
            <div class="page-header">
                <div class="page-title">
                    <h1>Academic Notes</h1>
                    <p>Manage and upload unit-wise study materials.</p>
                </div>
                <div class="search-box">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" placeholder="Search notes..." onkeyup="filterList('notesList', this.value)">
                </div>
            </div>

            <div class="glass">
                <h2><i class="fa-solid fa-cloud-arrow-up" style="color: var(--accent);"></i> New Content</h2>
                <div class="form-grid">
                    <div class="field">
                        <label>Department</label>
                        <select id="noteDept" onchange="loadSubjects('noteDept', 'noteSem', 'noteSubject')">
                            <option value="">Select Dept</option>
                            <option>CSE</option>
                            <option>ECE</option>
                            <option>ME</option>
                            <option>CE</option>
                            <option>EE</option>
                            <option>IT</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Semester</label>
                        <select id="noteSem" onchange="loadSubjects('noteDept', 'noteSem', 'noteSubject')">
                            <option value="">Select Sem</option>
                            <option value="1">Sem 1</option>
                            <option value="2">Sem 2</option>
                            <option value="3">Sem 3</option>
                            <option value="4">Sem 4</option>
                            <option value="5">Sem 5</option>
                            <option value="6">Sem 6</option>
                            <option value="7">Sem 7</option>
                            <option value="8">Sem 8</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Subject</label>
                        <select id="noteSubject">
                            <option value="">Select Dept & Sem</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Paper Code</label>
                        <input type="text" id="notePaperCode" placeholder="e.g. CS501">
                    </div>
                    <div class="field">
                        <label>Unit</label>
                        <select id="noteUnit">
                            <option value="">Select Unit</option>
                            <option value="1">Unit 1</option>
                            <option value="2">Unit 2</option>
                            <option value="3">Unit 3</option>
                            <option value="4">Unit 4</option>
                            <option value="5">Unit 5</option>
                            <option value="6">Unit 6</option>
                        </select>
                    </div>
                    <div class="field full-width">
                        <label>Title</label>
                        <input type="text" id="noteTitle" placeholder="e.g. Introduction to Data Structures">
                    </div>
                    <div class="field">
                        <label>Pricing Model</label>
                        <div style="display: flex; align-items: center; gap: 12px; height: 100%;">
                            <input type="checkbox" id="noteIsPremium"
                                onchange="togglePriceFields(this.checked, 'notePriceGroup')">
                            <span style="font-size: 14px; color: var(--text-dim);">Enable Premium Access</span>
                        </div>
                    </div>
                    <div class="field" id="notePriceGroup" style="display: none;">
                        <label>Price Tier (INR)</label>
                        <select id="notePrice">
                            <option value="49">₹49</option>
                            <option value="99">₹99</option>
                            <option value="129">₹129</option>
                            <option value="149">₹149</option>
                            <option value="199">₹199</option>
                            <option value="399">₹399</option>
                            <option value="699">₹699</option>
                        </select>
                    </div>
                    <div class="field full-width">
                        <label>PDF Asset</label>
                        <div class="dropzone" id="noteDropzone"
                            onclick="document.getElementById('noteFileInput').click()">
                            <i class="fa-solid fa-file-pdf"
                                style="font-size: 32px; color: var(--accent); margin-bottom: 12px;"></i>
                            <p id="noteFileName">Click or drop study material PDF</p>
                            <input type="file" id="noteFileInput" accept=".pdf" style="display: none;"
                                onchange="handleFileSelect(this, 'noteFileName')">
                        </div>
                    </div>
                    <div class="full-width" style="text-align: right;">
                        <button class="btn" id="noteUploadBtn" onclick="uploadNote()">
                            <i class="fa-solid fa-plus"></i>
                            <span>Publish Contribution</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="glass">
                <div class="table-header">
                    <h2>Recent Uploads</h2>
                    <div class="badge" id="noteCount">0 Items</div>
                </div>
                <div id="notesList">
                    <!-- Dynamic Items -->
                </div>
            </div>
        </section>

        <!-- SYLLABUS TAB -->
        <section id="syllabusTab" class="tab-content">
            <div class="page-header">
                <div class="page-title">
                    <h1>Syllabus</h1>
                    <p>Maintain the latest curriculum for all departments.</p>
                </div>
            </div>

            <div class="glass">
                <h2><i class="fa-solid fa-scroll" style="color: var(--cyan);"></i> Update Curriculum</h2>
                <div class="form-grid">
                    <div class="field">
                        <label>Department</label>
                        <select id="sylDept">
                            <option value="">Select Dept</option>
                            <option>CSE</option>
                            <option>ECE</option>
                            <option>ME</option>
                            <option>CE</option>
                            <option>EE</option>
                            <option>IT</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Semester</label>
                        <select id="sylSem">
                            <option value="">Select Sem</option>
                            <option value="1">Sem 1</option>
                            <option value="2">Sem 2</option>
                            <option value="3">Sem 3</option>
                            <option value="4">Sem 4</option>
                            <option value="5">Sem 5</option>
                            <option value="6">Sem 6</option>
                            <option value="7">Sem 7</option>
                            <option value="8">Sem 8</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Subject Name</label>
                        <input type="text" id="sylSubject" placeholder="e.g. Discrete Mathematics">
                    </div>
                    <div class="field">
                        <label>Version/Title</label>
                        <input type="text" id="sylTitle" placeholder="e.g. 2023 Revised Edition">
                    </div>
                    <div class="field">
                        <label>Paper Code</label>
                        <input type="text" id="sylPaperCode" placeholder="e.g. CS501">
                    </div>
                    <div class="field full-width">
                        <label>PDF Asset</label>
                        <div class="dropzone" id="sylDropzone"
                            onclick="document.getElementById('sylFileInput').click()">
                            <i class="fa-solid fa-scroll"
                                style="font-size: 32px; color: var(--accent); margin-bottom: 12px;"></i>
                            <p id="sylFileName">Drop syllabus PDF here</p>
                            <input type="file" id="sylFileInput" accept=".pdf" style="display: none;"
                                onchange="handleFileSelect(this, 'sylFileName')">
                        </div>
                    </div>
                    <div class="full-width" style="text-align: right;">
                        <button class="btn" id="sylUploadBtn" onclick="uploadSyllabus()">
                            <span>Deploy Syllabus</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="glass">
                <div class="table-header">
                    <h2>Library</h2>
                    <select class="badge btn-secondary" id="filterDept" onchange="loadSyllabus()"
                        style="border-radius: 8px;">
                        <option value="">Filter Dept</option>
                        <option>CSE</option>
                        <option>ECE</option>
                        <option>ME</option>
                        <option>CE</option>
                        <option>EE</option>
                        <option>IT</option>
                    </select>
                </div>
                <div id="syllabusList"></div>
            </div>
        </section>

        <!-- PYQ TAB -->
        <section id="pyqTab" class="tab-content">
            <div class="page-header">
                <div class="page-title">
                    <h1>Previous Year Questions</h1>
                    <p>Archive and organize university exam papers.</p>
                </div>
            </div>

            <div class="glass">
                <h2><i class="fa-solid fa-landmark" style="color: var(--orange);"></i> Add Question Paper</h2>
                <div class="form-grid">
                    <div class="field">
                        <label>Department</label>
                        <select id="pyqDept" onchange="loadSubjects('pyqDept', 'pyqSem', 'pyqSubject')">
                            <option value="">Select Dept</option>
                            <option>CSE</option>
                            <option>ECE</option>
                            <option>ME</option>
                            <option>CE</option>
                            <option>EE</option>
                            <option>IT</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Semester</label>
                        <select id="pyqSem" onchange="loadSubjects('pyqDept', 'pyqSem', 'pyqSubject')">
                            <option value="">Select Sem</option>
                            <option value="1">Sem 1</option>
                            <option value="2">Sem 2</option>
                            <option value="3">Sem 3</option>
                            <option value="4">Sem 4</option>
                            <option value="5">Sem 5</option>
                            <option value="6">Sem 6</option>
                            <option value="7">Sem 7</option>
                            <option value="8">Sem 8</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Subject</label>
                        <select id="pyqSubject">
                            <option value="">Select Dept & Sem</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Paper Code</label>
                        <input type="text" id="pyqPaperCode" placeholder="e.g. CS501">
                    </div>
                    <div class="field">
                        <label>Exam Year</label>
                        <input type="text" id="pyqYear" placeholder="e.g. 2022-2023">
                    </div>
                    <div class="field full-width">
                        <label>Exam Paper (PDF)</label>
                        <div class="dropzone" onclick="document.getElementById('pyqFileInput').click()">
                            <p id="pyqFileName">Choose exam paper</p>
                            <input type="file" id="pyqFileInput" accept=".pdf" style="display: none;"
                                onchange="handleFileSelect(this, 'pyqFileName')">
                        </div>
                    </div>
                    <div class="full-width" style="text-align: right;">
                        <button class="btn" style="background: var(--orange);" id="pyqUploadBtn" onclick="uploadPYQ()">
                            <span>Save to Archive</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="glass">
                <div id="pyqList"></div>
            </div>
        </section>

        <!-- EXAM FOCUS TAB -->
        <section id="impTab" class="tab-content">
            <div class="page-header">
                <div class="page-title">
                    <h1>Exam Focus (IMP)</h1>
                    <p>Highlight must-prepare topics and questions.</p>
                </div>
            </div>

            <div class="glass">
                <div class="form-grid">
                    <div class="field">
                        <label>Department</label>
                        <select id="impDept" onchange="loadSubjects('impDept', 'impSem', 'impSubject')">
                            <option value="">Select Dept</option>
                            <option>CSE</option>
                            <option>ECE</option>
                            <option>ME</option>
                            <option>CE</option>
                            <option>EE</option>
                            <option>IT</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Semester</label>
                        <select id="impSem" onchange="loadSubjects('impDept', 'impSem', 'impSubject')">
                            <option value="">Select Sem</option>
                            <option value="1">Sem 1</option>
                            <option value="2">Sem 2</option>
                            <option value="3">Sem 3</option>
                            <option value="4">Sem 4</option>
                            <option value="5">Sem 5</option>
                            <option value="6">Sem 6</option>
                            <option value="7">Sem 7</option>
                            <option value="8">Sem 8</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Subject</label>
                        <select id="impSubject">
                            <option value="">Select Dept & Sem</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Paper Code</label>
                        <input type="text" id="impPaperCode" placeholder="e.g. CS501">
                    </div>
                    <div class="field">
                        <label>Module Title</label>
                        <input type="text" id="impTitle" placeholder="e.g. Most Repeated Questions">
                    </div>
                    <div class="field full-width">
                        <div class="dropzone" onclick="document.getElementById('impFileInput').click()">
                            <p id="impFileName">Upload IMP PDF</p>
                            <input type="file" id="impFileInput" accept=".pdf" style="display: none;"
                                onchange="handleFileSelect(this, 'impFileName')">
                        </div>
                    </div>
                    <div class="full-width" style="text-align: right;">
                        <button class="btn" style="background: var(--red);" id="impUploadBtn" onclick="uploadIMP()">
                            <span>Publish Focus Points</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="glass">
                <div id="impList"></div>
            </div>
        </section>
        <!-- MONETIZATION TAB -->
        <section id="monetizationTab" class="tab-content">
            <div class="page-header">
                <div class="page-title">
                    <h1>Monetization & Pricing</h1>
                    <p>Configure pricing models and engagement thresholds.</p>
                </div>
            </div>

            <div class="glass">
                <h2><i class="fa-solid fa-tags" style="color: var(--orange);"></i> Subject Pricing (Tier 2)</h2>
                <div class="form-grid">
                    <div class="field">
                        <label>Department</label>
                        <select id="priceDept" onchange="loadSubjects('priceDept', 'priceSem', 'priceSubject')">
                            <option value="">Select Dept</option>
                            <option>CSE</option>
                            <option>ECE</option>
                            <option>ME</option>
                            <option>CE</option>
                            <option>EE</option>
                            <option>IT</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Semester</label>
                        <select id="priceSem" onchange="loadSubjects('priceDept', 'priceSem', 'priceSubject')">
                            <option value="">Select Sem</option>
                            <option value="1">Sem 1</option>
                            <option value="2">Sem 2</option>
                            <option value="3">Sem 3</option>
                            <option value="4">Sem 4</option>
                            <option value="5">Sem 5</option>
                            <option value="6">Sem 6</option>
                            <option value="7">Sem 7</option>
                            <option value="8">Sem 8</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Subject</label>
                        <select id="priceSubject">
                            <option value="">Select Subject</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Price Tier (INR)</label>
                        <select id="priceAmount">
                            <option value="49">₹49</option>
                            <option value="99">₹99</option>
                            <option value="129">₹129</option>
                            <option value="149">₹149</option>
                            <option value="199">₹199</option>
                            <option value="399">₹399</option>
                            <option value="699">₹699</option>
                        </select>
                    </div>
                    <div class="full-width" style="text-align: right;">
                        <button class="btn" style="background: var(--orange);" onclick="updateSubjectPrice()">
                            <span>Save Subject Price</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="glass">
                <h2><i class="fa-solid fa-cube" style="color: var(--green);"></i> Unit Pricing (Tier 2)</h2>
                <div class="form-grid">
                    <div class="field">
                        <label>Department</label>
                        <select id="unitDept" onchange="loadSubjects('unitDept', 'unitSem', 'unitSubject')">
                            <option value="">Select Dept</option>
                            <option>CSE</option>
                            <option>ECE</option>
                            <option>ME</option>
                            <option>CE</option>
                            <option>EE</option>
                            <option>IT</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Semester</label>
                        <select id="unitSem" onchange="loadSubjects('unitDept', 'unitSem', 'unitSubject')">
                            <option value="">Select Sem</option>
                            <option value="1">Sem 1</option>
                            <option value="2">Sem 2</option>
                            <option value="3">Sem 3</option>
                            <option value="4">Sem 4</option>
                            <option value="5">Sem 5</option>
                            <option value="6">Sem 6</option>
                            <option value="7">Sem 7</option>
                            <option value="8">Sem 8</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Subject</label>
                        <select id="unitSubject">
                            <option value="">Select Dept &amp; Sem</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Unit</label>
                        <select id="unitNumber">
                            <option value="1">Unit 1</option>
                            <option value="2">Unit 2</option>
                            <option value="3">Unit 3</option>
                            <option value="4">Unit 4</option>
                            <option value="5">Unit 5</option>
                            <option value="6">Unit 6</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Price Tier (INR)</label>
                        <select id="unitPrice">
                            <option value="49">₹49</option>
                            <option value="99">₹99</option>
                            <option value="129">₹129</option>
                            <option value="149">₹149</option>
                            <option value="199">₹199</option>
                            <option value="399">₹399</option>
                            <option value="699">₹699</option>
                        </select>
                    </div>
                    <div class="full-width" style="text-align: right;">
                        <button class="btn" style="background: var(--green);" onclick="updateUnitPrice()">
                            <span>Save Unit Price</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="glass">
                <h2><i class="fa-solid fa-layer-group" style="color: var(--accent);"></i> Semester Bundles (Tier 4)</h2>
                <div class="form-grid">
                    <div class="field">
                        <label>Department</label>
                        <select id="bundleDept">
                            <option value="">Select Dept</option>
                            <option>CSE</option>
                            <option>ECE</option>
                            <option>ME</option>
                            <option>CE</option>
                            <option>EE</option>
                            <option>IT</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Semester</label>
                        <select id="bundleSem">
                            <option value="">Select Sem</option>
                            <option value="1">Sem 1</option>
                            <option value="2">Sem 2</option>
                            <option value="3">Sem 3</option>
                            <option value="4">Sem 4</option>
                            <option value="5">Sem 5</option>
                            <option value="6">Sem 6</option>
                            <option value="7">Sem 7</option>
                            <option value="8">Sem 8</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Bundle Price Tier (INR)</label>
                        <select id="bundlePrice">
                            <option value="49">₹49</option>
                            <option value="99">₹99</option>
                            <option value="129">₹129</option>
                            <option value="149">₹149</option>
                            <option value="199">₹199</option>
                            <option value="399">₹399</option>
                            <option value="699">₹699</option>
                        </select>
                    </div>
                    <div class="full-width" style="text-align: right;">
                        <button class="btn" onclick="updateBundlePrice()">
                            <span>Create / Update Bundle</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="glass">
                <h2><i class="fa-solid fa-chart-line" style="color: var(--green);"></i> Engagement Thresholds</h2>
                <div class="form-grid">
                    <div class="field full-width">
                        <label>Preview Interactions Threshold (Paywall Nudge)</label>
                        <input type="number" id="nudgeThreshold" placeholder="e.g. 3">
                        <p style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">Number of interactions
                            before triggering the paywall.</p>
                    </div>
                    <div class="full-width" style="text-align: right;">
                        <button class="btn" style="background: var(--green);" onclick="updateThreshold()">
                            <span>Save Threshold</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- ── EDIT MODAL ── -->
    <div class="modal-wrap" id="editModal">
        <div class="modal login-card" style="text-align: left; max-width: 500px;">
            <div class="glass">
                <h2 id="modalTitle">Edit Entry</h2>
                <input type="hidden" id="editId">
                <input type="hidden" id="editType">

                <div id="syllabusFields">
                    <div class="field" style="margin-bottom: 16px;">
                        <label>Subject</label>
                        <input type="text" id="editSubject">
                    </div>
                    <div class="field" style="margin-bottom: 16px;">
                        <label>Title</label>
                        <input type="text" id="editTitle">
                    </div>
                </div>

                <div id="premiumFields" style="display: none;">
                    <div class="field" style="margin-bottom: 24px;">
                        <label>Access Control</label>
                        <div style="display: flex; align-items: center; gap: 12px; height: 50px;">
                            <input type="checkbox" id="editIsPremium"
                                onchange="togglePriceFields(this.checked, 'editPriceGroup')">
                            <span style="font-size: 14px; color: var(--text-dim);">Premium Content</span>
                        </div>
                    </div>
                    <div class="field" id="editPriceGroup" style="display: none; margin-bottom: 16px;">
                        <label>Price Tier (INR)</label>
                        <select id="editPrice">
                            <option value="49">₹49</option>
                            <option value="99">₹99</option>
                            <option value="129">₹129</option>
                            <option value="149">₹149</option>
                            <option value="199">₹199</option>
                            <option value="399">₹399</option>
                            <option value="699">₹699</option>
                        </select>
                    </div>
                </div>

                <div class="actions" style="margin-top: 32px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn" onclick="saveEdit()">Apply Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ── SYSTEM ── -->
    <div class="toast" id="toast">
        <i class="fa-solid fa-circle-check"></i>
        <span id="toastMsg">Action completed</span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        let sb = null;

        // ══════════════════════════════════════════
        //  CORE LOGIC
        // ══════════════════════════════════════════
        async function connect() {
            const url = document.getElementById('supaUrl').value.trim();
            const key = document.getElementById('supaKey').value.trim();
            const loginBtn = document.querySelector('.login-card .btn');
            const statusEl = document.getElementById('loginStatus');

            if (!url || !key) { statusEl.textContent = 'Project details required'; return; }

            loginBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Connecting...';

            try {
                sb = supabase.createClient(url, key);
                const { error } = await sb.from('notes').select('id').limit(1);
                if (error) throw error;

                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('sidebar').style.display = 'flex';
                document.getElementById('mainContent').style.display = 'block';

                showToast('Welcome to Admin Control', 'success');
                loadAll();
            } catch (e) {
                statusEl.textContent = 'Connection failed: ' + e.message;
                loginBtn.innerHTML = '<span>Connect Database</span><i class="fa-solid fa-arrow-right"></i>';
            }
        }

        function switchTab(tab, el) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            el.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        function loadAll() { loadNotes(); loadSyllabus(); loadPYQ(); loadIMP(); loadThreshold(); loadPricingTiers(); }

        // ══════════════════════════════════════════
        //  UI HELPERS
        // ══════════════════════════════════════════
        function handleFileSelect(input, displayId) {
            if (input.files[0]) {
                document.getElementById(displayId).textContent = input.files[0].name;
                document.getElementById(displayId).style.color = 'var(--accent)';
            }
        }

        function togglePriceFields(checked, groupId) {
            document.getElementById(groupId).style.display = checked ? 'flex' : 'none';
        }

        function showToast(msg, type = 'success') {
            const el = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = msg;
            el.className = `toast show ${type}`;
            setTimeout(() => el.className = 'toast', 3000);
        }

        function filterList(listId, query) {
            const items = document.querySelectorAll(`#${listId} .item-row`);
            const q = query.toLowerCase();
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(q) ? 'grid' : 'none';
            });
        }

        // ── Pricing Tiers: load from DB and populate ALL price selects ──
        async function loadPricingTiers() {
            try {
                const { data: tiers, error } = await sb
                    .from('pricing_tiers')
                    .select('price, product_id, label')
                    .order('sort_order');

                if (error || !tiers || tiers.length === 0) return; // fall back to hardcoded HTML options

                const optionsHtml = tiers
                    .map(t => `<option value="${t.price}" data-product="${t.product_id}">${t.label}</option>`)
                    .join('');

                // All price selects across the admin panel
                const priceSelectIds = [
                    'notePrice',      // Notes upload
                    'unitPrice',      // Unit Pricing card
                    'priceAmount',    // Subject Pricing card
                    'bundlePrice',    // Semester Bundles card
                    'editPrice',      // Edit modal
                ];

                priceSelectIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = optionsHtml;
                });

                console.log(`Loaded ${tiers.length} pricing tiers from DB`);
            } catch (e) {
                console.warn('Could not load pricing tiers:', e.message);
            }
        }

        // ══════════════════════════════════════════
        //  DATABASE DATA LOADERS
        // ══════════════════════════════════════════
        async function loadSubjects(deptId, semId, targetId) {
            const dept = document.getElementById(deptId).value;
            const sem = document.getElementById(semId).value;
            const target = document.getElementById(targetId);
            if (!dept || !sem) return;
            target.innerHTML = '<option>Loading...</option>';
            try {
                const { data } = await sb.from('department_subjects').select('subject, subject_price, paper_code')
                    .eq('department', dept).eq('semester', parseInt(sem)).order('subject');

                target.innerHTML = '<option value="">Select Subject</option>' +
                    data.filter(s => !s.subject.toLowerCase().includes('laboratory'))
                        .map(s => `<option value="${s.subject}" data-price="${s.subject_price || 0}" data-code="${s.paper_code || ''}">${esc(s.subject)} ${s.paper_code ? '[' + s.paper_code + ']' : ''}</option>`).join('');

                // Auto-fill paper code logic
                target.onchange = (e) => {
                    const opt = target.options[target.selectedIndex];
                    if (!opt) return;
                    const code = opt.getAttribute('data-code') || '';

                    const codeMap = {
                        'noteSubject': 'notePaperCode',
                        'sylSubject': 'sylPaperCode',
                        'pyqSubject': 'pyqPaperCode',
                        'impSubject': 'impPaperCode',
                        'priceSubject': 'priceAmount'
                    };

                    if (codeMap[targetId]) {
                        if (targetId === 'priceSubject') {
                            document.getElementById('priceAmount').value = opt.getAttribute('data-price') || 0;
                        } else {
                            document.getElementById(codeMap[targetId]).value = code;
                        }
                    }
                };
                // Trigger auto-fill if browser remembers selection or it's pre-selected
                if (target.value) target.onchange();
            } catch (e) { target.innerHTML = '<option>Error loading</option>'; }
        }

        async function loadNotes() {
            const { data } = await sb.from('notes').select('*').order('uploaded_at', { ascending: false });
            const list = document.getElementById('notesList');
            document.getElementById('noteCount').textContent = `${data.length} Items`;
            list.innerHTML = data.map(n => `
                <div class="item-row">
                    <div class="item-main">
                        <div class="item-name">${esc(n.title)} ${n.is_premium ? '⭐' : ''}</div>
                        <div class="item-sub">${esc(n.department)} · Sem ${n.semester} · ${esc(n.subject)} · ${n.paper_code ? '<b>[' + esc(n.paper_code) + ']</b>' : ''}</div>
                    </div>
                    <div class="badge ${n.is_premium ? 'badge-premium' : ''}">${n.is_premium ? '₹' + n.price : 'FREE'}</div>
                    <div class="badge">U${n.unit}</div>
                    <div class="actions">
                        <button class="icon-btn" onclick="window.open('${n.file_url}')"><i class="fa-solid fa-eye"></i></button>
                        <button class="icon-btn" onclick="openEdit('note', '${n.id}', ${n.is_premium}, ${n.price}, null, null, '${n.paper_code || ''}')"><i class="fa-solid fa-pen"></i></button>
                        <button class="icon-btn delete" onclick="deleteItem('notes', 'notes_pdf', '${n.id}', '${n.file_url}')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        async function loadSyllabus() {
            let query = sb.from('syllabus').select('*').order('department');
            const dept = document.getElementById('filterDept').value;
            if (dept) query = query.eq('department', dept);
            const { data } = await query;
            document.getElementById('syllabusList').innerHTML = data.map(s => `
                <div class="item-row">
                    <div class="item-main">
                        <div class="item-name">${esc(s.subject)} ${s.paper_code ? '<b>[' + esc(s.paper_code) + ']</b>' : ''}</div>
                        <div class="item-sub">${esc(s.department)} · Sem ${s.semester} · ${esc(s.title)}</div>
                    </div>
                    <div class="badge">CURRICULUM</div>
                    <div class="badge">S${s.semester}</div>
                    <div class="actions">
                        <button class="icon-btn" onclick="window.open('${s.file_url}')"><i class="fa-solid fa-eye"></i></button>
                        <button class="icon-btn" onclick="openEdit('syllabus', '${s.id}', false, 0, '${esc(s.subject)}', '${esc(s.title)}', '${s.paper_code || ''}')"><i class="fa-solid fa-pen"></i></button>
                        <button class="icon-btn delete" onclick="deleteItem('syllabus', 'syllabus_pdf', '${s.id}', '${s.file_url}')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        async function loadPYQ() {
            const { data } = await sb.from('pyq').select('*').order('year', { ascending: false });
            document.getElementById('pyqList').innerHTML = data.map(p => `
                <div class="item-row">
                    <div class="item-main">
                        <div class="item-name">${esc(p.subject)} (${p.year})</div>
                        <div class="item-sub">${esc(p.department)} · Sem ${p.semester} ${p.paper_code ? '· <b>[' + esc(p.paper_code) + ']</b>' : ''}</div>
                    </div>
                    <div class="badge">${p.year}</div>
                    <div class="actions">
                        <button class="icon-btn" onclick="window.open('${p.file_url}')"><i class="fa-solid fa-eye"></i></button>
                        <button class="icon-btn" onclick="openEdit('pyq', '${p.id}', false, 0, '${esc(p.subject)}', '${p.year}', '${p.paper_code || ''}')"><i class="fa-solid fa-pen"></i></button>
                        <button class="icon-btn delete" onclick="deleteItem('pyq', 'pyqs_pdf', '${p.id}', '${p.file_url}')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        async function loadIMP() {
            const { data } = await sb.from('important_questions').select('*').order('uploaded_at', { ascending: false });
            document.getElementById('impList').innerHTML = data.map(p => `
                <div class="item-row">
                    <div class="item-main">
                        <div class="item-name">${esc(p.title)}</div>
                        <div class="item-sub">${esc(p.department)} · Sem ${p.semester} · ${esc(p.subject)} ${p.paper_code ? '· <b>[' + esc(p.paper_code) + ']</b>' : ''}</div>
                    </div>
                    <div class="badge" style="color:var(--red);">IMP</div>
                    <div class="actions">
                        <button class="icon-btn" onclick="window.open('${p.file_url}')"><i class="fa-solid fa-eye"></i></button>
                        <button class="icon-btn" onclick="openEdit('important_questions', '${p.id}', false, 0, '${esc(p.subject)}', '${esc(p.title)}', '${p.paper_code || ''}')"><i class="fa-solid fa-pen"></i></button>
                        <button class="icon-btn delete" onclick="deleteItem('important_questions', 'important_questions_pdf', '${p.id}', '${p.file_url}')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        // ══════════════════════════════════════════
        //  DATABASE MUTATIONS
        // ══════════════════════════════════════════
        async function uploadNote() {
            const btn = document.getElementById('noteUploadBtn');
            const file = document.getElementById('noteFileInput').files[0];
            const dept = document.getElementById('noteDept').value;
            const sem = parseInt(document.getElementById('noteSem').value);
            const sub = document.getElementById('noteSubject').value;
            const unit = parseInt(document.getElementById('noteUnit').value);
            const title = document.getElementById('noteTitle').value;
            const code = document.getElementById('notePaperCode').value;
            const isPrem = document.getElementById('noteIsPremium').checked;
            const price = parseFloat(document.getElementById('notePrice').value) || 0;

            if (!file || !dept || !sem || !sub || !title) return showToast('Fill all fields', 'error');

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Uploading...';

            try {
                // 1. Upload File with robust name
                const cleanSub = sub.replace(/[^a-z0-9]/gi, '_');
                const cleanTitle = title.replace(/[^a-z0-9]/gi, '_');
                const path = `${dept}/Sem${sem}/${cleanSub}/U${unit}/${Date.now()}_${cleanTitle}.pdf`;

                await sb.storage.from('notes_pdf').upload(path, file);
                const { data: url } = sb.storage.from('notes_pdf').getPublicUrl(path);

                // 2. Prepare base meta
                const baseMeta = {
                    department: dept,
                    semester: sem,
                    subject: sub,
                    unit: unit,
                    title: title,
                    paper_code: code,
                    is_premium: isPrem,
                    is_preview: unit === 1 || unit === 2,
                    price: isPrem ? price : 0,
                    file_url: url.publicUrl
                };

                // 3. Find siblings for multiplexing
                let targets = [baseMeta];
                if (code && code.trim()) {
                    const { data: siblings } = await sb.from('department_subjects')
                        .select('department, semester, subject')
                        .eq('paper_code', code.trim());

                    if (siblings) {
                        const seen = new Set([`${dept}|${sem}|${sub}`]);
                        siblings.forEach(s => {
                            const key = `${s.department}|${s.semester}|${s.subject}`;
                            if (!seen.has(key)) {
                                seen.add(key);
                                targets.push({ ...baseMeta, department: s.department, semester: s.semester, subject: s.subject });
                            }
                        });
                    }
                }

                const { error } = await sb.from('notes').insert(targets);
                if (error) throw error;

                showToast(`Study material published to ${targets.length} depts`);
                loadNotes();
                document.getElementById('noteTitle').value = '';
                document.getElementById('notePaperCode').value = '';
                document.getElementById('noteFileInput').value = '';
                document.getElementById('noteFileName').textContent = 'Click or drop study material PDF';
            } catch (e) { showToast(e.message, 'error'); }
            finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-plus"></i><span>Publish Contribution</span>'; }
        }

        async function uploadSyllabus() {
            const btn = document.getElementById('sylUploadBtn');
            const file = document.getElementById('sylFileInput').files[0];
            const dept = document.getElementById('sylDept').value;
            const sem = parseInt(document.getElementById('sylSem').value);
            const sub = document.getElementById('sylSubject').value;
            const title = document.getElementById('sylTitle').value;
            const code = document.getElementById('sylPaperCode').value;

            if (!file || !dept || !sub) return showToast('Details required', 'error');

            btn.disabled = true;
            try {
                const cleanSub = sub.replace(/[^a-z0-9]/gi, '_');
                const path = `${dept}/Sem${sem}/${cleanSub}_Syllabus_${Date.now()}.pdf`;
                await sb.storage.from('syllabus_pdf').upload(path, file);
                const { data: url } = sb.storage.from('syllabus_pdf').getPublicUrl(path);

                const meta = {
                    department: dept,
                    semester: sem,
                    subject: sub,
                    title: title,
                    paper_code: code,
                    file_url: url.publicUrl
                };

                await sb.from('syllabus').insert(meta);
                showToast('Curriculum updated');
                loadSyllabus();
                document.getElementById('sylSubject').value = '';
                document.getElementById('sylTitle').value = '';
                document.getElementById('sylPaperCode').value = '';
                document.getElementById('sylFileInput').value = '';
            } catch (e) { showToast(e.message, 'error'); }
            finally { btn.disabled = false; }
        }

        async function uploadPYQ() {
            const btn = document.getElementById('pyqUploadBtn');
            const file = document.getElementById('pyqFileInput').files[0];
            const dept = document.getElementById('pyqDept').value;
            const sem = parseInt(document.getElementById('pyqSem').value);
            const sub = document.getElementById('pyqSubject').value;
            const year = document.getElementById('pyqYear').value;
            const code = document.getElementById('pyqPaperCode').value;

            if (!file || !dept || !sem || !sub || !year) return showToast('Fill all fields', 'error');
            btn.disabled = true;

            try {
                // 1. Upload File
                const cleanSub = sub.replace(/[^a-z0-9]/gi, '_');
                const path = `${dept}/PYQ/${year}/${Date.now()}_${cleanSub}.pdf`;
                await sb.storage.from('pyqs_pdf').upload(path, file);
                const { data: url } = sb.storage.from('pyqs_pdf').getPublicUrl(path);

                // 2. Base meta
                const baseMeta = {
                    department: dept,
                    semester: sem,
                    subject: sub,
                    year: year,
                    paper_code: code,
                    file_url: url.publicUrl
                };

                // 3. Multiplex
                let targets = [baseMeta];
                if (code && code.trim()) {
                    const { data: siblings } = await sb.from('department_subjects')
                        .select('department, semester, subject')
                        .eq('paper_code', code.trim());

                    if (siblings) {
                        const seen = new Set([`${dept}|${sem}|${sub}`]);
                        siblings.forEach(s => {
                            const key = `${s.department}|${s.semester}|${s.subject}`;
                            if (!seen.has(key)) {
                                seen.add(key);
                                targets.push({ ...baseMeta, department: s.department, semester: s.semester, subject: s.subject });
                            }
                        });
                    }
                }

                const { error } = await sb.from('pyq').insert(targets);
                if (error) throw error;

                showToast(`PYQ archived for ${targets.length} depts`);
                loadPYQ();
                document.getElementById('pyqYear').value = '';
                document.getElementById('pyqPaperCode').value = '';
                document.getElementById('pyqFileInput').value = '';
            } catch (e) { showToast(e.message, 'error'); }
            finally { btn.disabled = false; }
        }

        async function uploadIMP() {
            const btn = document.getElementById('impUploadBtn');
            const file = document.getElementById('impFileInput').files[0];
            const dept = document.getElementById('impDept').value;
            const sem = parseInt(document.getElementById('impSem').value);
            const sub = document.getElementById('impSubject').value;
            const title = document.getElementById('impTitle').value;
            const code = document.getElementById('impPaperCode').value;

            if (!file || !dept || !sem || !sub) return showToast('Fill all fields', 'error');
            btn.disabled = true;

            try {
                // 1. Upload File with robust name
                const cleanSub = sub.replace(/[^a-z0-9]/gi, '_');
                const cleanTitle = title.replace(/[^a-z0-9]/gi, '_');
                const path = `IMP/${dept}/Sem${sem}/${Date.now()}_${cleanSub}_${cleanTitle}.pdf`;

                await sb.storage.from('important_questions_pdf').upload(path, file);
                const { data: url } = sb.storage.from('important_questions_pdf').getPublicUrl(path);

                // 2. Prepare base meta
                const baseMeta = {
                    department: dept,
                    semester: sem,
                    subject: sub,
                    title: title,
                    paper_code: code,
                    file_url: url.publicUrl
                };

                // 3. Find sibling departments if paper_code exists
                let targets = [baseMeta];
                if (code && code.trim()) {
                    const { data: siblings } = await sb.from('department_subjects')
                        .select('department, semester, subject')
                        .eq('paper_code', code.trim());

                    if (siblings && siblings.length > 0) {
                        // Create unique set of targets (avoid self-duplication if also in query)
                        const seen = new Set([`${dept}|${sem}|${sub}`]);
                        siblings.forEach(s => {
                            const key = `${s.department}|${s.semester}|${s.subject}`;
                            if (!seen.has(key)) {
                                seen.add(key);
                                targets.push({
                                    ...baseMeta,
                                    department: s.department,
                                    semester: s.semester,
                                    subject: s.subject
                                });
                            }
                        });
                    }
                }

                // 4. Batch insert
                const { error } = await sb.from('important_questions').insert(targets);
                if (error) throw error;

                showToast(`Focus points published to ${targets.length} departments`);
                loadIMP();

                // Clear UI
                document.getElementById('impTitle').value = '';
                document.getElementById('impPaperCode').value = '';
                document.getElementById('impFileInput').value = '';
                document.getElementById('impFileName').textContent = 'Upload IMP PDF';
            } catch (e) { showToast(e.message, 'error'); }
            finally { btn.disabled = false; }
        }

        async function updateUnitPrice() {
            const dept = document.getElementById('unitDept').value;
            const sem = parseInt(document.getElementById('unitSem').value);
            const sub = document.getElementById('unitSubject').value;
            const unit = parseInt(document.getElementById('unitNumber').value);
            const price = parseFloat(document.getElementById('unitPrice').value);
            if (!dept || !sem || !sub || isNaN(unit) || isNaN(price)) return showToast('Fill all fields', 'error');
            try {
                const { error } = await sb.from('unit_prices')
                    .upsert({ department: dept, semester: sem, subject: sub, unit, price }, { onConflict: 'department,semester,subject,unit' });
                if (error) throw error;
                showToast(`Unit ${unit} price set to ₹${price}`);
            } catch (e) { showToast(e.message, 'error'); }
        }

        async function updateSubjectPrice() {
            const dept = document.getElementById('priceDept').value;
            const sem = parseInt(document.getElementById('priceSem').value);
            const sub = document.getElementById('priceSubject').value;
            const price = parseFloat(document.getElementById('priceAmount').value);
            if (!dept || !sem || !sub || isNaN(price)) return showToast('Fill all fields', 'error');
            try {
                const { count, error } = await sb.from('department_subjects')
                    .update({ subject_price: price }, { count: 'exact' })
                    .eq('department', dept).eq('semester', sem).eq('subject', sub);

                if (error) throw error;
                if (count === 0) {
                    showToast('Subject not found in sync table', 'error');
                } else {
                    showToast('Subject price updated successfully');
                }
            } catch (e) { showToast(e.message, 'error'); }
        }

        async function updateBundlePrice() {
            const dept = document.getElementById('bundleDept').value;
            const sem = parseInt(document.getElementById('bundleSem').value);
            const price = parseFloat(document.getElementById('bundlePrice').value);
            if (!dept || !sem || isNaN(price)) return showToast('Fill all fields', 'error');
            try {
                const { data, error } = await sb.from('semester_bundles')
                    .upsert({ department: dept, semester: sem, bundle_price: price }, { onConflict: 'department,semester' })
                    .select();
                if (error) throw error;
                if (data && data.length > 0) {
                    const { count } = await sb.from('department_subjects')
                        .update({ semester_bundle_id: data[0].id }, { count: 'exact' })
                        .eq('department', dept).eq('semester', sem);
                    console.log(`Updated ${count} subjects with bundle ID`);
                }
                showToast('Bundle price created/updated');
            } catch (e) { showToast(e.message, 'error'); }
        }

        async function updateThreshold() {
            const val = document.getElementById('nudgeThreshold').value;
            if (!val) return;
            try {
                const { error } = await sb.from('app_settings')
                    .upsert({ setting_key: 'preview_interactions_threshold', setting_value: JSON.parse(val) }, { onConflict: 'setting_key' });
                if (error) throw error;
                showToast('Threshold saved');
            } catch (e) { showToast(e.message, 'error'); }
        }

        async function loadThreshold() {
            try {
                const { data } = await sb.from('app_settings').select('setting_value').eq('setting_key', 'preview_interactions_threshold').single();
                if (data) document.getElementById('nudgeThreshold').value = data.setting_value;
            } catch (e) { console.log(e); }
        }

        async function deleteItem(table, bucket, id, url) {
            if (!confirm('Permanent delete?')) return;
            try {
                const storagePath = decodeURIComponent(url.split(`/${bucket}/`)[1]);
                await sb.storage.from(bucket).remove([storagePath]);
                await sb.from(table).delete().eq('id', id);
                showToast('Resource deleted');
                loadAll();
            } catch (e) { showToast(e.message, 'error'); }
        }

        // ══════════════════════════════════════════
        //  MODAL / EDIT
        // ══════════════════════════════════════════
        function openEdit(type, id, isPrem, price, sub, title) {
            document.getElementById('editId').value = id;
            document.getElementById('editType').value = type;

            if (type === 'note' || type === 'pyq' || type === 'important_questions') {
                const titleMap = { 'note': 'Edit Note Access', 'pyq': 'Edit PYQ Paper', 'important_questions': 'Edit Exam Focus' };
                document.getElementById('modalTitle').textContent = titleMap[type] || 'Edit Entry';

                document.getElementById('syllabusFields').style.display = 'none';
                document.getElementById('premiumFields').style.display = 'block';

                // Note specific
                if (type === 'note') {
                    document.querySelector('#premiumFields .field:first-child').style.display = 'block'; // Access Control
                    document.getElementById('editIsPremium').checked = isPrem;
                    document.getElementById('editPrice').value = price;
                    document.getElementById('editPriceGroup').style.display = isPrem ? 'flex' : 'none';
                } else {
                    document.querySelector('#premiumFields .field:first-child').style.display = 'none'; // Hide Access Control
                    document.getElementById('editPriceGroup').style.display = 'none';
                }

                // Add paper code to modal
                if (!document.getElementById('editPaperCodeField')) {
                    const div = document.createElement('div');
                    div.id = 'editPaperCodeField';
                    div.className = 'field';
                    div.style.marginBottom = '16px';
                    div.innerHTML = '<label>Paper Code</label><input type="text" id="editPaperCode">';
                    document.getElementById('premiumFields').appendChild(div);
                }
                document.getElementById('editPaperCode').value = arguments[6] || '';

                // For PYQ/IMP, we might also want to edit subject/title
                if (type === 'pyq' || type === 'important_questions') {
                    document.getElementById('syllabusFields').style.display = 'block';
                    document.getElementById('editSubject').value = sub;
                    document.getElementById('editTitle').value = title;
                    document.querySelector('#syllabusFields label:last-of-type').textContent = type === 'pyq' ? 'Year' : 'Title';
                }
            } else {
                document.getElementById('modalTitle').textContent = 'Edit Syllabus';
                document.getElementById('syllabusFields').style.display = 'block';
                document.getElementById('premiumFields').style.display = 'none';
                document.getElementById('editSubject').value = sub;
                document.getElementById('editTitle').value = title;

                // Add paper code to modal
                if (!document.getElementById('editSylPaperCodeField')) {
                    const div = document.createElement('div');
                    div.id = 'editSylPaperCodeField';
                    div.className = 'field';
                    div.style.marginBottom = '16px';
                    div.innerHTML = '<label>Paper Code</label><input type="text" id="editSylPaperCode">';
                    document.getElementById('syllabusFields').appendChild(div);
                }
                document.getElementById('editSylPaperCode').value = arguments[6] || '';
            }
            document.getElementById('editModal').classList.add('show');
        }

        function closeModal() { document.getElementById('editModal').classList.remove('show'); }

        async function saveEdit() {
            const id = document.getElementById('editId').value;
            const type = document.getElementById('editType').value;
            let payload = {};

            if (type === 'note') {
                const is_premium = document.getElementById('editIsPremium').checked;
                payload = {
                    is_premium,
                    price: is_premium ? parseFloat(document.getElementById('editPrice').value) : 0,
                    paper_code: document.getElementById('editPaperCode').value
                };
            } else if (type === 'pyq') {
                payload = {
                    subject: document.getElementById('editSubject').value,
                    year: document.getElementById('editTitle').value,
                    paper_code: document.getElementById('editPaperCode').value
                };
            } else if (type === 'important_questions') {
                payload = {
                    subject: document.getElementById('editSubject').value,
                    title: document.getElementById('editTitle').value,
                    paper_code: document.getElementById('editPaperCode').value
                };
            } else {
                payload = {
                    subject: document.getElementById('editSubject').value,
                    title: document.getElementById('editTitle').value,
                    paper_code: document.getElementById('editSylPaperCode').value
                };
            }

            try {
                await sb.from(type === 'note' ? 'notes' : (type === 'important_questions' ? 'important_questions' : type)).update(payload).eq('id', id);
                showToast('Entry updated');
                closeModal();
                loadAll();
            } catch (e) { showToast(e.message, 'error'); }
        }

        function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
    </script>
</body>

</html>